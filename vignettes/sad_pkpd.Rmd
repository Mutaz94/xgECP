---
title: "PKPD Single Ascending Dose example"
author: "Fariba Khanshan, Andrew Stein, Alison Margolskee"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    self_contained: yes
vignette: >
  %\VignetteIndexEntry{PKPD Single Ascending Dose example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7
)
```

## Overview

This document contains exploratory plots for single ascending dose PK and PD 
data as well as the R code that generates these graphs. The plots presented 
here are based on simulated data.

## Setup

```{r, warning=FALSE, message=FALSE}
library(xgxr)
library(ggplot2)
library(dplyr)

# flag for labeling figures as draft
status <- "DRAFT"
 
# ggplot settings
xgx_theme_set()
```

## Load Dataset

```{r, warning=FALSE, message=FALSE}
pkpd_data <- case1_pkpd %>%
  arrange(DOSE) %>%
  mutate(TRTACT = factor(TRTACT, levels = unique(TRTACT)))
 
pk_data <- pkpd_data %>%
  filter(CMT == 2)

pk_data_cycle1 <- pk_data %>%
  filter(CYCLE == 1)
 
pk_data_revdose <- pk_data_cycle1 %>%
  mutate(TRTACT = factor(TRTACT, levels = rev(levels(TRTACT))))

pd_data <- pkpd_data %>%
  filter(CMT == 3)
 
pd_data_revdose <- pd_data %>%
  mutate(TRTACT = factor(TRTACT, levels = rev(levels(TRTACT))))

NCA <- pk_data_cycle1 %>%
  group_by(ID, DOSE) %>%
  filter(!is.na(LIDV)) %>%
  summarize(AUC_last = caTools::trapz(TIME, LIDV),
            Cmax = max(LIDV)) %>%
  tidyr::gather(PARAM,VALUE,-c(ID, DOSE)) %>%
  ungroup() %>%
  mutate(VALUE_NORM = VALUE / DOSE)
 
time_units_dataset <- "hours"
time_units_plot    <- "days"
trtact_label       <- "Dose"
dose_label         <- "Dose (mg)"
conc_label         <- "Concentration (ng/ml)" 
auc_label          <- "AUCtau (h.(ng/ml))"
concnorm_label     <- "Normalized Concentration (ng/ml)/mg"
sex_label          <- "Sex"
w100_label         <- "WEIGHTB>100"
pd_label           <- "FEV1 (mL)"
```

## Provide an overview of the data

Summarize the data in a way that is easy to visualize the general trend of PK 
over time and between doses. Using summary statistics can be helpful, e.g. 
Mean +/- SE, or median, 5th & 95th percentiles. Consider either coloring by 
dose or faceting by dose. Depending on the amount of data one graph may be 
better than the other.

When looking at summaries of PK over time, there are several things to observe. 
Note the number of doses and number of time points or sampling schedule. 
Observe the overall shape of the average profiles. What is the average 
Cmax per dose? Tmax? Does the elimination phase appear to be parallel across 
the different doses? Is there separation between the profiles for different 
doses? Can you make a visual estimate of the number of compartments that 
would be needed in a PK model?

### Concentration over time, colored by Dose, mean +/- 95% CI

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
ggplot(data = pk_data_revdose, aes(x = NOMTIME,
                                   y = LIDV,
                                   group = DOSE,
                                   color = TRTACT)) +
  xgx_geom_ci(conf_level = 0.95) +
  xgx_scale_y_log10() +
  xgx_scale_x_time_units(units_dataset = time_units_dataset) +
  labs(y = conc_label, color = trtact_label) +
  xgx_annotate_status(status)
```

### Concentration over time, faceted by Dose, mean +/- 95% CI, overlaid on gray spaghetti plots

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
ggplot(data = pk_data_cycle1, aes(x = NOMTIME, y = LIDV)) +
  geom_line(aes(group = ID), color = rgb(0.5, 0.5, 0.5), size = 1, alpha = 0.3) +
  scale_shape_manual(values = c(1, 8)) +
  scale_color_manual(values = c("grey50", "red")) +
  xgx_geom_ci(aes(x = NOMTIME, color = NULL, group = NULL), conf_level = 0.95) +
  xgx_scale_y_log10() +
  xgx_scale_x_time_units(units_dataset = time_units_dataset) +
  labs(y = conc_label, color = trtact_label) +
  theme(legend.position = "none") +
  facet_grid(.~TRTACT) +
  xgx_annotate_status(status)
```

## Assess the dose linearity of exposure

### Dose Normalized Concentration over time, colored by Dose, mean +/- 95% CI

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
ggplot(data = pk_data_revdose,
       aes(x = NOMTIME,
           y = LIDV / as.numeric(as.character(DOSE)),
           group = DOSE,
           color = TRTACT)) +
  xgx_geom_ci(conf_level = 0.95, alpha = 0.5, position = position_dodge(1)) +
  xgx_scale_y_log10() +
  xgx_scale_x_time_units(units_dataset = time_units_dataset) +
  labs(y = concnorm_label, color = trtact_label) +
  xgx_annotate_status(status)

```

### NCA of dose normalized AUC and Cmax vs Dose

Observe the dose normalized AUC and Cmax over different doses. Does the 
relationship appear to be constant across doses or do some doses stand 
out from the rest? Can you think of reasons why some would stand out? For 
example, the lowest dose may have dose normalized AUC much higher than the 
rest, could this be due to BLQ observations? If the highest doses have dose 
normalized AUC much higher than the others, could this be due to nonlinear 
clearance, with clearance saturating at higher doses? If the highest doses 
have dose normalized AUC much lower than the others, could there be saturation 
of bioavailability, reaching the maximum absorbable dose?

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
ggplot(data = NCA, aes(x = DOSE, y = VALUE_NORM)) + 
  geom_boxplot(aes(group = DOSE)) +
  geom_smooth(method = "lm", color = "black") +
  facet_wrap(~PARAM, scales = "free_y") +
  labs(x = dose_label) +
  theme(axis.title.y = element_blank()) +
  xgx_annotate_status(status)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
ggplot(data = NCA[!NCA$DOSE == 3 & !NCA$DOSE == 10 , ],
       aes(x = DOSE, y = VALUE_NORM)) +
  geom_boxplot(aes(group = DOSE)) +
  geom_smooth(method = "lm", color = "black") +
  facet_wrap(~PARAM, scales = "free_y") +
  labs(x = dose_label) +
  theme(axis.title.y = element_blank()) +
  xgx_annotate_status(status)
```

## Explore covariate effects on PK

### Concentration over time, colored by categorical covariate, mean +/- 95% CI

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
ggplot(data = pk_data_revdose, aes(x = NOMTIME,
                                   y = LIDV,
                                   group = WEIGHTB > 100,
                                   color = WEIGHTB > 100)) + 
  xgx_geom_ci(conf_level = 0.95) +
  xgx_scale_y_log10() +
  xgx_scale_x_time_units(units_dataset = time_units_dataset) +
  facet_grid(.~DOSE) +
  labs(y = conc_label, color = w100_label) +
  xgx_annotate_status(status)
```

## PD marker over time, colored by Dose, mean (95% CI) percentiles by nominal time

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
ggplot(data = pd_data_revdose, aes(x = NOMTIME / 24,
                                   y = LIDV,
                                   group = DOSE,
                                   color = TRTACT)) +
  xgx_geom_ci(conf_level = 0.95) +
  xgx_scale_y_log10() + 
  xgx_scale_x_time_units(units_dataset = time_units_plot) + 
  labs(y = pd_label, color = trtact_label) + 
  xgx_annotate_status(status)
```

## PD marker over time, faceted by Dose, dots & lines grouped by individuals

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
ggplot(data = pd_data, aes(x = NOMTIME / 24, y = LIDV)) +
  geom_line(aes(group = ID), alpha = 0.5) +
  geom_point(alpha = 0.5) +
  xgx_scale_y_log10() + 
  xgx_scale_x_time_units(units_dataset = time_units_plot) +
  facet_grid(~TRTACT) +
  labs(y = pd_label, color = trtact_label) +
  xgx_annotate_status(status)
```

## Explore Dose-Response Relationship
One of the key questions when looking at PD markers is to determine if there 
is a dose-response relationship, and if there is, what dose is necessary to 
achieve the desired effect? Simple dose-response plots can give insight into 
these questions.

### PD marker by Dose, for endpoint of interest, mean (95% CI) by Dose
Plot PD marker against dose. Using summary statistics can be helpful, e.g. 
Mean +/- SE, or median, 5th & 95th percentiles.

Here are some questions to ask yourself when looking at Dose-Response plots: 
Do you see any relationship? Does response increase (decrease) with 
increasing dose? Are you able to detect a plateau or emax (emin) on the 
effect? If so, around what dose does this occur?

Warning: Even if you don’t see an Emax, that doesn’t mean there isn’t one. 
Be very careful about using linear models for Dose-Response relationships. 
Extrapolation outside of the observed dose range could indicate a higher dose 
is always better (even if it isn’t).

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
pd_data$DAY_label <- paste("Day", pd_data$PROFDAY)
pd_data$DAY_label[pd_data$DAY_label == "Day 0"] <- "Baseline"
pd_data_baseline_day85 <- pd_data[pd_data$DAY_label %in% c("Baseline", "Day 85"), ]

ggplot(data = pd_data_baseline_day85, aes(x = DOSE,
                                          y = LIDV,
                                          group = DOSE)) +
  xgx_geom_ci(conf_level = 0.95) + 
  stat_summary(geom = "point", fun.y = mean) +
  guides(color = guide_legend(""), fill = guide_legend("")) +
  facet_grid(~DAY_label) +
  labs(y = pd_label, color = trtact_label) +
  xgx_annotate_status(status)
```

### PD marker by Dose, faceted by visit, mean (95% CI) by Dose

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
pd_data_visit <- pd_data[pd_data$DAY_label %in% c("Baseline",
                                                  "Day 14",
                                                  "Day 28",
                                                  "Day 56",
                                                  "Day 85"), ]

ggplot(data = pd_data_visit, aes(x = DOSE, y = LIDV, group = DOSE)) +
  xgx_geom_ci(conf_level = 0.95) +
  stat_summary(geom = "point", fun.y = mean) +
  guides(color = guide_legend(""), fill = guide_legend("")) +
  facet_grid(~DAY_label) +
  labs(y = pd_label, color = trtact_label) +
  xgx_annotate_status(status)
```

### Explore covariate effects on Dose-Response relationship

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
ggplot(data = pd_data_baseline_day85, aes(x = DOSE,
                                          y = LIDV,
                                          group = WEIGHTB > 100,
                                          color = WEIGHTB > 100)) +
  xgx_geom_ci(conf_level = .95) +
  stat_summary(geom = "point", fun.y = mean) +
  facet_grid(~DAY_label) +
  labs(y = pd_label, color = w100_label) +
  xgx_annotate_status(status)
```

## Explore Exposure-Response Relationship

Plot PD marker against concentration. Do you see any relationship? Does 
response increase (decrease) with increasing dose? Are you able to detect 
a plateau or emax (emin) on the effect?

Warning: Even if you don’t see an Emax, that doesn’t mean there isn’t one. 
Be very careful about using linear models for Dose-Response or 
Exposure-Response relationships. Extrapolation outside of the observed 
dose range could indicate a higher dose is always better (even if it isn’t).

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
pkpd_data$DAY_label <- paste("Day", pkpd_data$PROFDAY)
pkpd_data$DAY_label[pkpd_data$DAY_label == "Day 0"] <- "Baseline"
pkpd_data_day85 <- pkpd_data[pkpd_data$DAY_label %in% c("Day 85"), ]
data_to_plot <- list()
data_to_plot[[1]] <- pkpd_data_day85[pkpd_data_day85$CMT == 2
                                     & pkpd_data_day85$TRTACT != "Placebo"
                                     & pkpd_data_day85$PROFDAY == 85,
                                     c("TIME", "LIDV", "ID", "TRTACT", "CENS")]
data_to_plot[[1]]$Concentration <- data_to_plot[[1]]$LIDV
data_to_plot[[1]]$LIDV <- NULL

data_to_plot[[2]] <- pkpd_data_day85[pkpd_data_day85$CMT == 3
                                     & pkpd_data_day85$PROFDAY == 85,
                                     c("TIME", "LIDV", "ID", "TRTACT")]

data_to_plot[[2]]$Response <- data_to_plot[[2]]$LIDV
data_to_plot[[2]]$LIDV <- NULL
data_to_plot2 <- merge(data_to_plot[[1]], data_to_plot[[2]],
                       by = c("TIME", "ID", "TRTACT"))
data_to_plot2$TRTACT <- factor(data_to_plot2$TRTACT,
                               levels = rev(levels(data_to_plot2$TRTACT)))

ggplot(data = data_to_plot2, aes(x = Concentration, y = Response)) +
  geom_point(aes(color = TRTACT)) +
  geom_point(data = data_to_plot2[data_to_plot2$CENS == 1, ], 
             color = "red", shape = 8) +
  guides(color = guide_legend(""), fill = guide_legend("")) +
  xgx_scale_x_log10() +
  labs(y = pd_label, x = conc_label) +
  xgx_annotate_status(status)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
pkpd_data$DAY_label <- paste("Day", pkpd_data$PROFDAY)
data_to_plot <- list()
data_to_plot[[1]] <- pkpd_data[pkpd_data$CMT == 2 
                               & pkpd_data$PROFDAY %in% c(1, 14, 28, 56, 85),
                               c("TIME", "LIDV", "ID", "TRTACT", "CENS", "PROFDAY")]
data_to_plot[[1]]$Concentration <- data_to_plot[[1]]$LIDV
data_to_plot[[1]]$LIDV <- NULL

data_to_plot[[2]] <- pkpd_data[pkpd_data$CMT == 3 
                               & pkpd_data$PROFDAY %in% c(1, 14, 28, 56, 85),
                               c("TIME", "LIDV", "ID", "TRTACT", "PROFDAY")]
data_to_plot[[2]]$Response <- data_to_plot[[2]]$LIDV
data_to_plot[[2]]$LIDV <- NULL

data_to_plot2 <- merge(data_to_plot[[1]], data_to_plot[[2]],
                       by = c("TIME", "ID", "TRTACT", "PROFDAY"))
data_to_plot2$DAY_label <- paste("Day", data_to_plot2$PROFDAY)
data_to_plot2$TRTACT <- factor(data_to_plot2$TRTACT,
                               levels = rev(levels(data_to_plot2$TRTACT)))

ggplot(data = data_to_plot2, aes(x = Concentration,
                                 y = Response,
                                 color = TRTACT)) + 
  geom_point() +
  geom_point(data = data_to_plot2[data_to_plot2$CENS == 1, ],
             color = "red", shape = 8) +
  xgx_scale_x_log10() +
  guides(color = guide_legend(""), fill = guide_legend("")) +
  facet_grid(~DAY_label) +
  labs(y = pd_label, x = conc_label) +
  xgx_annotate_status(status)
```

Plotting AUC vs response instead of concentration vs response may make more 
sense in some situations. For example, when there is a large delay between 
PK and PD it would be diffcult to relate the time-varying concentration with 
the response. If rich sampling is only done at a particular point in the 
study, e.g. at steady state, then the AUC calculated on the rich profile 
could be used as the exposure variable for a number of PD visits. If PK 
samples are scarce, average Cmin could also be used as the exposure metric.


```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.height=3}
AUC_0_24 <- NCA[NCA$PARAM == "AUC_last", c("ID", "VALUE")]

names(AUC_0_24) <- c("ID","AUC")
AUC_0_24$PROFDAY <- 1
if (length(AUC_0_24[is.na(AUC_0_24$AUC),]$AUC) > 0 ) {
  AUC_0_24[is.na(AUC_0_24$AUC), ]$AUC <- 0
}

AUCtau <- pkpd_data[pkpd_data$CMT == 2 & pkpd_data$NOMTIME >= 2015.9 
                    & pkpd_data$NOMTIME <= 2039.9, ]
AUCtau <- data.frame(stack(sapply(split(AUCtau, AUCtau$ID),
                                  function(df) caTools::trapz(df$TIME, df$LIDV))))
names(AUCtau) <- c("AUC", "ID")
AUCtau$PROFDAY <- 85
if (length(AUCtau[is.na(AUCtau$AUC), ]$AUC) > 0 ) {
  AUCtau[is.na(AUCtau$AUC), ]$AUC <- 0
}

AUC <- rbind(AUC_0_24, AUCtau)
AUC$ID <- as.numeric(as.character(AUC$ID))
AUC <- AUC[order(AUC$ID,AUC$PROFDAY), ]

RESPONSE <- pkpd_data[pkpd_data$CMT == 3 & pkpd_data$PROFDAY %in% c(1, 85),
                      c("ID", "PROFDAY", "LIDV", "DOSE", "TRTACT")]
names(RESPONSE) <- c("ID", "PROFDAY", "Response", "DOSE", "TRTACT")

data_to_plot <- merge(AUC, RESPONSE, by = c("ID", "PROFDAY"))
data_to_plot$ID <- as.numeric(as.character(data_to_plot$ID))
data_to_plot <- data_to_plot[order(data_to_plot$ID, data_to_plot$PROFDAY), ]

data_to_plot$DAY_label <- paste("Day", data_to_plot$PROFDAY)

data_to_plot$AUC_bins <- cut(data_to_plot$AUC,
                             quantile(data_to_plot$AUC, na.rm = TRUE),
                             na.rm = TRUE)
data_to_plot <- data_to_plot %>%
  group_by(AUC_bins) %>%
  mutate(AUC_midpoints = median(AUC))

data_to_plot$TRTACT <- factor(data_to_plot$TRTACT,
                              levels = rev(levels(data_to_plot$TRTACT)))

ggplot(data = data_to_plot, aes(x = AUC, y = Response)) +
  geom_point(aes(color = TRTACT)) + geom_smooth(color = "black") +
  xgx_geom_ci(geom = "pointrange", data = data_to_plot,
              mapping = aes(x = AUC_midpoints, y = Response),
              shape = 0) +
  xgx_scale_x_log10() +
  guides(color = guide_legend(""), fill = guide_legend("")) +
  facet_grid(~DAY_label) +
  labs(y = pd_label, x = auc_label) +
  xgx_annotate_status(status)
```

## R Session Info

```{r}
sessionInfo()
```

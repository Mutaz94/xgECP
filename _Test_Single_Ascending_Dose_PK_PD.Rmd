---
title: "Test_PK_PD_Single Ascending Dose_Pastoor_Dataset"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---
 
## Overview
 
This document contains exploratory plots for single ascending dose PK data as well as the R code that generates these graphs. The plots presented here are based on simulated data ([see: PKPD Datasets](PKPD_Datasets.html)). You may also download the Single Ascending Dose PK dataset for your reference ([download dataset](Data/Single_Ascending_Dose_Dataset2.csv)). Data specifications can be accessed on [Datasets](Datasets.html) and Rmarkdown template to generate this page can be found on [Rmarkdown-Template](Rmarkdown/Single_Ascending_Dose_PK.Rmd).
 
## Setup
 
```{r, warning=FALSE, message=FALSE}
# remove reference to home directory in libPaths
.libPaths(grep("home", .libPaths(), value=TRUE, invert=TRUE))
.libPaths(grep("usr",  .libPaths(), value=TRUE, invert=TRUE))
 
# add localLib to libPaths for locally installed packages
#.libPaths(c("../Rlib", .libPaths()))
 
# will load from first filepath first, then look in .libPaths for more packages not in first path
# version matches package in first filepath, in the case of multiple instances of a package
 
# library(rmarkdown)
devtools::load_all()
library(gridExtra)
library(grid)
library(ggplot2)
library(dplyr)
library(RxODE)
library(caTools)
library(xgxr)
library(tidyr)
 
#flag for labeling figures as draft
status = "DRAFT"
 
## ggplot settings
xgx_theme_set()
 
```
 
## Load Dataset
 
```{r, warning=FALSE, message=FALSE}
data <- read.csv("data/Single_Ascending_Dose_PKPD_dpastoor.csv")

pkpd_data <- data %>%
  arrange(DOSE) %>%
  mutate(TRTACT = paste0(pkpd_data$DOSE, "mg"),factor(TRTACT, levels = unique(TRTACT))) 
 
pkpd_data_revdose <- pkpd_data %>%
  mutate(TRTACT = factor(TRTACT, levels = rev(levels(TRTACT))))
 
NCA = pkpd_data %>%
  group_by(ID,DOSE) %>%
  filter(!is.na(COBS)) %>%
  summarize(AUC_last = trapz(TIME,COBS),
            Cmax     = max(COBS)) %>%
  gather(PARAM,VALUE,-c(ID,DOSE)) %>%
  ungroup() %>%
  mutate(VALUE_NORM = VALUE/DOSE)
 
time_units_dataset = "hours"
time_units_plot    = "days"
trtact_label       = "Dose"
dose_label         = "Dose (mg)"
conc_label         = "Concentration (ng/ml)" 
concnorm_label     = "Normalized Concentration (ng/ml)/mg"
```
 
## Provide an overview of the data
 
Summarize the data in a way that is easy to visualize the general trend of PK over time and between doses. Using summary statistics can be helpful, e.g. Mean +/- SE, or median, 5th & 95th percentiles. Consider either coloring by dose or faceting by dose. Depending on the amount of data one graph may be better than the other.
 
When looking at summaries of PK over time, there are several things to observe. Note the number of doses and number of time points or sampling schedule. Observe the overall shape of the average profiles. What is the average Cmax per dose? Tmax? Does the elimination phase appear to be parallel across the different doses? Is there separation between the profiles for different doses? Can you make a visual estimate of the number of compartments that would be needed in a PK model?
 
### Concentration over time, colored by Dose, mean +/- 95% CI
 
```{r , cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE, fig.width = 8, fig.height = 4}
 
gg <- ggplot(data = pkpd_data_revdose, aes(x = TIME, y = COBS, group= DOSE, color = TRTACT))
 
gg <- gg + xgx_geom_ci(percentile = .95, position = position_dodge(width = 1))
gg <- gg + xgx_scale_y_log10()
gg <- gg + xgx_scale_x_time_units(units_dataset = time_units_dataset)
gg <- gg + labs(y=conc_label,color = trtact_label)
gg <- gg + xgx_annotate_status(status)
print(gg)
```
 
### Concentration over time, faceted by Dose, mean +/- 95% CI, overlaid on gray spaghetti plots
 
```{r , cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 3}
 
gg <- ggplot(data = pkpd_data, aes(x = TIME, y = COBS))
gg <- gg + geom_line(aes(group = ID), color = rgb(0.5,0.5,0.5), size = 1, alpha = 0.3) 
#gg <- gg + geom_point(aes(color = factor(CENS), shape = factor(CENS), alpha = 0.3), size = 2, alpha = 0.3)
gg <- gg + scale_shape_manual(values=c(1,8))
gg <- gg + scale_color_manual(values=c("grey50","red"))
gg <- gg + xgx_geom_ci(aes(x = TIME, color=NULL, group=NULL), percentile = 0.95)
gg <- gg + xgx_scale_y_log10()
gg <- gg + xgx_scale_x_time_units(units_dataset = time_units_dataset)
gg <- gg + labs(y=conc_label,color = trtact_label)
gg <- gg + theme(legend.position="none") + facet_grid(.~TRTACT)
gg <- gg + xgx_annotate_status(status)
print(gg)
```
 
## Assess the dose linearity of exposure
 
### Dose Normalized Concentration over time, colored by Dose, mean +/- 95% CI
 
```{r , cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE, fig.width = 8, fig.height = 4}
gg <- ggplot(data = pkpd_data_revdose,
             aes(x = TIME, y = COBS/as.numeric(as.character(DOSE)),
                 group= DOSE, color = TRTACT))
gg <- gg + xgx_geom_ci(percentile = 0.95, alpha = 0.5, position = position_dodge(1))
gg <- gg + xgx_scale_y_log10()
gg <- gg + xgx_scale_x_time_units(units_dataset = time_units_dataset)
gg <- gg + labs(y=conc_label,color = trtact_label)
gg <- gg + xgx_annotate_status(status)
print(gg)
```
 
### NCA of dose normalized AUC and Cmax vs Dose
 
Observe the dose normalized AUC and Cmax over different doses. Does the relationship appear to be constant across doses or do some doses stand out from the rest? Can you think of reasons why some would stand out? For example, the lowest dose may have dose normalized AUC much higher than the rest, could this be due to BLQ observations? If the highest doses have dose normalized AUC much higher than the others, could this be due to nonlinear clearance, with clearance saturating at higher doses? If the highest doses have dose normalized AUC much lower than the others, could there be saturation of bioavailability, reaching the maximum absorbable dose?
 
```{r, cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE, fig.width = 8, fig.height = 4}
gg <- ggplot(data = NCA, aes(x = DOSE, y = VALUE_NORM))
gg <- gg + geom_boxplot(aes(group = DOSE))
gg <- gg + geom_smooth(method = "lm", color = "black")
gg <- gg + facet_wrap(~PARAM, scales = "free_y")
gg <- gg + labs(x = dose_label, y = concnorm_label)
gg <- gg + xgx_annotate_status(status)
print(gg)
 
```
 

## R Session Info
```{r}
sessionInfo()
```